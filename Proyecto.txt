
/* sistema que simule un inventario de una tienda de abarrotes: se requiere crear archivos con los
productos, precios, existencias, listas ligadas para manipular el inventario diario, guardar en archivos
los reportes de venta diarios y un menú para dar de alta, baja o modificar los productos, precios y ver
reportes por fechas.*/

#include <stdio.h>

#include <string.h>

#include <malloc.h>

#include <stdlib.h>

#include <time.h>

typedef struct{ 
	char nombre[30];
	int codigo;
	float precio;
	int existencia;
}Producto;

typedef struct nodoPr {
	Producto  p;
	struct nodoPr *siguiente;
}Nodo;
//19.-Vaciar memoria
void vaciar(){
	fflush(stdin);
	fflush(stdout);
}
//1.-Crear una lista
Nodo *crearlista(){
	Nodo *cabeza=NULL;
	return cabeza;
}
//16.-Comprobar si un valor es int
int comprobar_Codigo(Nodo *tempC){
		int a;
		if(scanf("%i", &a) != 1){
			return 0;
		}
		else{
			tempC->p.codigo=a;
			return 1;
		}
}
//17.-Comprobar si un valor es int
int comprobar_Existencia(Nodo *tempC){
	int d;
	if(scanf("%i", &d) != 1){
		return 0;
	}
	else{
		tempC->p.existencia=d;
		return 1;
	}
}
//18.-Comprobar si un valor es int
int comprobar_float(Nodo *tempC){
	float b;
	if(scanf("%f", &b) != 1)
		return 0;
	else{
		tempC->p.precio=b;
		return 1;
	}
}
	
//2.-Crear un Nodo
Nodo *crearNodo(){
	Nodo *temp;
	int comprobar=0;
	temp=(struct nodoPr *) malloc(sizeof(struct nodoPr));
	printf("Proporciona el nombre del producto: \n");
	gets(temp->p.nombre);
	vaciar();
	printf("Proporciona el codigo del producto: \n");
	comprobar=comprobar_Codigo(temp);
	vaciar();
	while(comprobar==0){
		printf("Digite un número entero: \n");
		comprobar=comprobar_Codigo(temp);
		vaciar();
	}
	vaciar();
	//Producto
	printf("Proporciona el precio del producto: \n");
	comprobar=comprobar_float(temp);
	vaciar();
	while(comprobar==0){
		printf("Digite un número flotante o entero: \n");
		comprobar=comprobar_float(temp);
		vaciar();
	}
	vaciar();
	//Existencia
	printf("Proporciona la existencia: \n");
	comprobar=comprobar_Existencia(temp);
	vaciar();
	while(comprobar==0){
		printf("Digite un número entero: \n");
		comprobar=comprobar_Existencia(temp);
		vaciar();
	}
	vaciar();
	temp->siguiente=NULL;
	return temp;
}
//3.-Insertar al final de la lista
void insertarFinal(Nodo **cabeza)
	
{   
	Nodo *ultimo;
	ultimo = *cabeza;
	if(ultimo==NULL){
		*cabeza = crearNodo();
	}
	else{
		while(ultimo->siguiente!= NULL){
			ultimo=ultimo->siguiente;
		}
		ultimo->siguiente=crearNodo();
	}
}
//4.-Borra un nodo de la lista
void eliminar_Nodo(int codigoB, Nodo **cabeza){
	Nodo *actual=*cabeza;
	Nodo *anterior=NULL;
	while((actual!=NULL)&&(actual->p.codigo != codigoB)){
		anterior=actual;
		actual=actual->siguiente;
	}
	if(actual==NULL){//No se encontro el nodo o esta vacia la lista
		if(*cabeza==NULL)printf("La lista esta vacia\n");
		else printf("No se encontro el elemento en la lista\n");
	}
	else{
		if(*cabeza==actual){//Borraremos el primer elemento
			*cabeza=actual->siguiente;
		}
		else {
			anterior->siguiente=actual->siguiente;
			free(actual);
			printf("Elemento borrado\n");
		}
	}
		
	}	
//5.-Modificar un nodo de la lista
void modificar_Nodo(int codigoB, Nodo **cabeza){
		Nodo *actual=*cabeza;
		Nodo *anterior;
		while((actual!=NULL)&&(actual->p.codigo != codigoB)){
			anterior=actual;
			actual=actual->siguiente;
		}
		if(actual==NULL){//No se encontro el nodo o esta vacia la lista
			if(*cabeza==NULL)printf("La lista esta vacia\n");
			else printf("No se encontro el elemento en la lista\n");
		}
		else{
			if(*cabeza==actual){//Borraremos el primer elemento
				*cabeza = crearNodo();
			}
			else {
				anterior->siguiente=crearNodo();
				printf("Producto modificado correctamente \n");
			}
		}
		
	}	

//6.-Eliminar lista	
void eliminarLista(Nodo **cabeza){
	Nodo *primero;//Eliminaremos el nodo al inicio de la lista
	while(*cabeza != NULL){
		primero = *cabeza;
		*cabeza = primero->siguiente;
		free(primero);
	}
	printf("Lista eliminada\n");
	
}
//7.-Guardar en un archivo
void guardarT(char nombreF[],Nodo *cabeza){
	Nodo *aux=cabeza;
	FILE *archivo;
	archivo = fopen(nombreF,"w+");
	if(archivo!=NULL){
		while (aux!=NULL){
			fprintf(archivo,"%d %s %f %d\n",aux->p.codigo,aux->p.nombre,aux->p.precio,aux->p.existencia);
			aux=aux->siguiente;
		}
		}
	fclose(archivo);
}


//8.-Mostrar la lista 
void mostrarLista(Nodo *cabeza){
	if (cabeza==NULL){
		printf("No hay elementos en la lista\n");
	}
	else{
		Nodo *aux;
		printf("Los elementos de la lista son:\n");
		for(aux=cabeza; aux!=NULL ;aux=aux->siguiente){
			printf("Codigo:%d Producto:%s Precio:%f Existencia:%d \n",aux->p.codigo,aux->p.nombre, aux->p.precio, aux->p.existencia);
		}
	}
}
//---Funciones que retornan valores para el menú---
//9.-Pedir codigo
int pedir_codigo(){
	int a;
	scanf("%d",&a);
	return a;
}
	
//10.-Fecha
char *cadena_Fecha(){
	char *output=(char*)malloc(15);
	time_t tiempo = time(0);
	struct tm *tlocal = localtime(&tiempo);
	strftime(output,10,"%d-%m-%y",tlocal);
	return output;
}
//11.-Regresa un valor entero para la opcion
int opcion(int o,char *temp){
		o=atoi(temp);
		return o;
		
}
//------
//12.-Mostrar lo que tienen un archivo
	void leerT(char nombreFile[]){
	FILE *archivo;
	char nombre[30];
	int codigo;
	float precio;
	int existencia;
	puts("el contenido del archivo es");
	archivo = fopen(nombreFile,"r");
	if (archivo!=NULL)
	{
	while( fscanf(archivo,"%d\n%s\n%f\n%d\n",&codigo,nombre,&precio,&existencia)!=-1 )
	{
		printf("Codigo:%d\nProducto:%s\nPrecio:%f\nExistencia:%d\n",codigo,nombre,precio,existencia);
	}
		fclose(archivo);
	
	}
}
//13.-Menu
void menu(){
		printf("------\tMenú\t------\n");
		printf("1.- Dar de alta productos \n");
		printf("2.- Mostrar lista \n");
		printf("3.- Borrar un elemento de la lista \n");
		printf("4.- Modificar un elemento de la lista\n");
		printf("5.- Gurdar el reporte\n");
		printf("6.- Borrar toda la lista\n");
		printf("7.- Mostrar lo que tiene un documento\n");
		printf("8.- Salir\n");
}
//14.-Encabezado Nice
void encabezadoUWU(){
		printf("\n===========================================================================\n");
		printf("\t\t\t      PROYECTO FINAL\t\t\t\n");
		printf("\t\t\t   Abarroterias Don Diws\t\t\t\n");
		printf("\t\t\t    Fundada desde 2021\t\t\t\n");
		printf("\t\t     Copyright 2021 | Equipo quesadilla\t\t\t\n");
		printf("===========================================================================\n");
}
//15.-Funcion principal 
		int main(){
			encabezadoUWU();
			char *output;
			output=cadena_Fecha();
			int op=0;
			char temp[5];
			Nodo *ap = crearlista();
			int borrarP, modificarP;
			do{
			menu();
			fgets(temp,5,stdin);
			op=opcion(op,temp);
			switch(op){
				case 1: 
					insertarFinal(&ap);
					break;
				case 2:
					mostrarLista(ap);
					break;	
				case 3:
					printf("Digite el codigo del producto que quiere eliminar:\n");
					borrarP = pedir_codigo();
					eliminar_Nodo(borrarP,&ap);
					break;
				case 4:
					printf("Digite el codigo del producto que quiere modificar:\n");
					modificarP=pedir_codigo();
					modificar_Nodo(modificarP,&ap);
					break;
				case 5:
					guardarT(output,ap);
					break;
				case 6:
					eliminarLista(&ap);
					break;
				case 7: 
					leerT("16-11-21");
					break;
				case 8:
					printf("Saliendo...");
					break;
				default:
					printf("Escoga una opción dentro del menú");
					break;
				}
			}while(op!=8);
			return 0;
		}